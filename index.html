<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovelMint — Profile</title>
<style>
  :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--accent:#38bdf8}
  body{margin:0;font-family:Poppins,system-ui;background:var(--bg);color:white}
  header{background:var(--card);padding:12px 16px;color:var(--accent);text-align:center;font-weight:700}
  .profile{padding:16px;text-align:center}
  .avatar{width:100px;height:100px;border-radius:50%;background:#334155;object-fit:cover}
  .name{color:#93c5fd;font-size:1.2em;margin-top:8px}
  .bio{color:var(--muted);margin:6px 0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;padding:12px}
  .card{background:var(--card);padding:12px;border-radius:10px}
  .card-title{color:#93c5fd;font-weight:700}
  footer{background:var(--card);text-align:center;padding:12px;color:var(--muted)}
</style>
</head>
<body>
  <header>Writer Profile</header>
  <div id="profile" class="profile"><div style="color:var(--muted)">Loading...</div></div>
  <h3 style="text-align:center;color:var(--accent);margin:8px 0">Published Works</h3>
  <div id="posts" class="grid"><div style="color:var(--muted);text-align:center;width:100%">Loading...</div></div>
  <footer>© 2025 NovelMint</footer>

<script type="module">
  import { db } from './app.js';
  import { doc, getDoc, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

  const params = new URLSearchParams(window.location.search);
  const uid = params.get('id');
  const profile = document.getElementById('profile');
  const posts = document.getElementById('posts');

  async function loadProfile(){
    if (!uid) { profile.innerHTML = '<div style="color:red">No user specified.</div>'; return; }
    try {
      const pRef = doc(db,'publicUsers',uid);
      const psnap = await getDoc(pRef);
      if (psnap.exists()){
        const d = psnap.data();
        profile.innerHTML = `<img class="avatar" src="${d.photoURL||'https://via.placeholder.com/100'}"><div class="name">${escapeHtml(d.displayName||d.name||'Unknown')}</div><div class="bio">${escapeHtml(d.bio||'No bio yet.')}</div>`;
      } else {
        profile.innerHTML = '<div style="color:var(--muted)">Profile not found.</div>';
      }

      // load posts
      const q = query(collection(db,'contents'), where('authorId','==',uid), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      posts.innerHTML = '';
      if (snap.empty){ posts.innerHTML = '<div style="color:var(--muted);text-align:center;width:100%">No posts yet.</div>'; return; }
      snap.forEach(docu => {
        const d = docu.data();
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<div class="card-title">${escapeHtml(d.title||'Untitled')}</div><div style="color:#cbd5e1">${escapeHtml((d.content||'').slice(0,140))}${(d.content && d.content.length>140)?'...':''}</div>`;
        posts.appendChild(el);
      });

    } catch (err) {
      console.error(err);
      profile.innerHTML = '<div style="color:red">Failed to load profile.</div>';
      posts.innerHTML = '<div style="color:red">Failed to load posts.</div>';
    }
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  loadProfile();
</script>
</body>
</html>
