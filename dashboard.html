<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovelMint ‚Äî Dashboard</title>
<style>
  :root{--bg:#0f172a;--side:#0b1220;--panel:#0f172a;--card:#1e293b;--accent:#38bdf8;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:Poppins,system-ui;background:var(--bg);color:white;min-height:100vh}
  .wrap{display:flex;gap:20px;padding:16px}
  aside{width:220px;background:var(--card);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px}
  aside h2{margin:0;color:var(--accent);text-align:center}
  main{flex:1}
  .panel{background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b1220;color:white;margin-bottom:10px}
  input[type=file]{padding:6px}
  button{padding:10px;border-radius:8px;border:none;background:var(--accent);color:#022;cursor:pointer;font-weight:600}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:900px){.wrap{flex-direction:column}aside{width:100%}}
</style>
</head>
<body>
  <div class="wrap">
    <aside>
      <h2>NovelMint</h2>
      <button id="goHome">üè† View Site</button>
      <button id="logoutBtn" style="background:#ef4444;color:white">Logout</button>
      <div class="small">Tip: complete your profile for public view</div>
    </aside>

    <main>
      <!-- Profile panel (shown automatically if no profile data) -->
      <div id="profilePanel" class="panel">
        <h3 style="margin-top:0;color:var(--accent)">Your Profile</h3>
        <label>Username (unique display)</label>
        <input id="username" placeholder="e.g. riya_writer" />
        <label>Full name</label>
        <input id="fullname" placeholder="e.g. Riya Sharma" />
        <label>Bio</label>
        <textarea id="bio" rows="3" placeholder="Write something about you..."></textarea>
        <label>Profile photo (optional)</label>
        <input id="photo" type="file" accept="image/*" />
        <button id="saveProfile">Save Profile</button>
        <div id="profileStatus" class="small"></div>
      </div>

      <!-- Publish panel -->
      <div class="panel">
        <h3 style="margin-top:0;color:var(--accent)">Publish New Content</h3>
        <input id="title" placeholder="Title" />
        <select id="type"><option>Story</option><option>Poem</option><option>Book</option><option>Thought</option></select>
        <textarea id="content" rows="6" placeholder="Write your content..."></textarea>
        <label class="small">Cover image (optional)</label>
        <input id="cover" type="file" accept="image/*" />
        <button id="publishBtn">Publish</button>
        <div id="publishStatus" class="small"></div>
      </div>

      <!-- My works list -->
      <div id="worksPanel" class="panel">
        <h3 style="margin-top:0;color:var(--accent)">Your Published Works</h3>
        <div id="worksList" class="small">Loading...</div>
      </div>
    </main>
  </div>

<script type="module">
  import { auth, db, storage } from './app.js';
  import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
  import { doc, getDoc, setDoc, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
  import { ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js';

  const profilePanel = document.getElementById('profilePanel');
  const usernameEl = document.getElementById('username');
  const fullnameEl = document.getElementById('fullname');
  const bioEl = document.getElementById('bio');
  const photoEl = document.getElementById('photo');
  const saveProfileBtn = document.getElementById('saveProfile');
  const profileStatus = document.getElementById('profileStatus');

  const titleEl = document.getElementById('title');
  const typeEl = document.getElementById('type');
  const contentEl = document.getElementById('content');
  const coverEl = document.getElementById('cover');
  const publishBtn = document.getElementById('publishBtn');
  const publishStatus = document.getElementById('publishStatus');

  const worksList = document.getElementById('worksList');
  const logoutBtn = document.getElementById('logoutBtn');
  const goHome = document.getElementById('goHome');

  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = 'login.html';
    currentUser = user;
    await loadProfile();
    await loadWorks();
  });

  goHome.addEventListener('click', () => location.href = 'index.html');
  logoutBtn.addEventListener('click', async () => { await signOut(auth); location.href = 'login.html'; });

  async function loadProfile(){
    profileStatus.textContent = 'Loading profile...';
    try {
      const uRef = doc(db, 'users', currentUser.uid);
      const snap = await getDoc(uRef);
      if (snap.exists()) {
        const d = snap.data();
        usernameEl.value = d.username || '';
        fullnameEl.value = d.fullname || '';
        bioEl.value = d.bio || '';
        // hide profile panel? keep visible to allow edit
        profileStatus.textContent = 'Profile loaded. You can edit and save.';
      } else {
        // first time user ‚Äî show panel with empty fields
        profileStatus.textContent = 'Please complete your profile to be visible publicly.';
      }
    } catch (err) {
      console.error(err);
      profileStatus.textContent = '‚ö†Ô∏è Failed to load profile.';
    }
  }

  saveProfileBtn.addEventListener('click', async () => {
    profileStatus.textContent = 'Saving...';
    try {
      let photoURL = '';
      const file = photoEl.files[0];
      if (file) {
        const fRef = storageRef(storage, `profiles/${currentUser.uid}_${Date.now()}_${file.name}`);
        await uploadBytes(fRef, file);
        photoURL = await getDownloadURL(fRef);
      }
      const profileData = {
        username: usernameEl.value.trim() || currentUser.email.split('@')[0],
        fullname: fullnameEl.value.trim() || '',
        bio: bioEl.value.trim() || '',
        photoURL: photoURL || null,
        updatedAt: new Date().toISOString()
      };
      // Save to private users collection
      await setDoc(doc(db, 'users', currentUser.uid), profileData, { merge:true });
      // Also save public minimal info to publicUsers for browsing
      await setDoc(doc(db, 'publicUsers', currentUser.uid), {
        name: profileData.fullname || profileData.username,
        displayName: profileData.username,
        photoURL: profileData.photoURL || null,
        bio: profileData.bio || '',
        joinDate: new Date().toLocaleDateString()
      }, { merge:true });

      profileStatus.textContent = '‚úÖ Profile saved.';
      await loadProfile();
    } catch (err) {
      console.error(err);
      profileStatus.textContent = '‚ùå Error saving profile: ' + err.message;
    }
  });

  // Publish handler
  publishBtn.addEventListener('click', async () => {
    publishStatus.textContent = 'Publishing...';
    const title = titleEl.value.trim();
    const type = typeEl.value;
    const content = contentEl.value.trim();
    if (!title || !content) { publishStatus.textContent = '‚ö†Ô∏è Title and content required.'; return; }

    try {
      // get author display name
      const userSnap = await getDoc(doc(db, 'users', currentUser.uid));
      const udata = userSnap.exists() ? userSnap.data() : {};
      const displayName = udata.username || udata.fullname || currentUser.email.split('@')[0];

      let coverUrl = '';
      const file = coverEl.files[0];
      if (file) {
        const cRef = storageRef(storage, `covers/${currentUser.uid}_${Date.now()}_${file.name}`);
        await uploadBytes(cRef, file);
        coverUrl = await getDownloadURL(cRef);
      }

      // Add content doc
      await addDoc(collection(db, 'contents'), {
        title,
        type,
        content,
        coverUrl,
        author: displayName,
        authorId: currentUser.uid,
        publishDate: new Date().toLocaleDateString(),
        createdAt: serverTimestamp()
      });

      // Ensure publicUsers has name (so profile link shows)
      await setDoc(doc(db, 'publicUsers', currentUser.uid), {
        name: udata.fullname || displayName,
        displayName: udata.username || displayName,
        photoURL: udata.photoURL || null
      }, { merge:true });

      // clear form
      titleEl.value = '';
      contentEl.value = '';
      coverEl.value = '';
      publishStatus.textContent = '‚úÖ Published successfully!';
      await loadWorks();
    } catch (err) {
      console.error(err);
      publishStatus.textContent = '‚ùå ' + err.message;
    }
  });

  // Load user's works
  async function loadWorks(){
    try {
      const q = query(collection(db, 'contents'), where('authorId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      worksList.innerHTML = '';
      if (snap.empty) { worksList.textContent = 'No posts yet.'; return; }
      snap.forEach(docu => {
        const d = docu.data();
        const el = document.createElement('div');
        el.style.padding = '8px 0';
        el.innerHTML = `<strong>${escapeHtml(d.title)}</strong> <div style="color:var(--muted);font-size:13px">${escapeHtml(d.publishDate||'')}</div>`;
        worksList.appendChild(el);
      });
    } catch (err) {
      console.error(err);
      worksList.textContent = 'Failed to load your posts.';
    }
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
