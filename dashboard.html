<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NovelMint â€” Dashboard</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#1e293b; --muted:#94a3b8; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui;background:var(--bg);color:#fff;min-height:100vh;display:flex}
    /* sidebar */
    .sidebar{width:220px;background:var(--panel);padding:18px;display:flex;flex-direction:column;gap:12px}
    .brand{color:var(--accent);font-weight:700;font-size:20px;text-align:center}
    .btn{background:var(--accent);border:none;padding:10px;border-radius:8px;color:#001;cursor:pointer}
    .btn.danger{background:#ef4444;color:#fff}
    /* main */
    main{flex:1;padding:20px}
    .row{display:flex;gap:16px;align-items:flex-start}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px}
    .profile-overview{max-width:720px;margin-bottom:18px}
    .profile-meta p{margin:6px 0;color:var(--muted)}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b1220;color:#fff;margin:8px 0}
    .small{max-width:320px}
    .note{color:var(--muted);font-size:14px;margin-top:8px}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:flex;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal.hidden{display:none}
    .modal-card{background:var(--panel);padding:18px;border-radius:12px;width:100%;max-width:520px}
    .modal-card h3{color:var(--accent);margin:0 0 8px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    @media(max-width:760px){.sidebar{width:100%;flex-direction:row;justify-content:space-between}.row{flex-direction:column}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">ðŸŒ¿ NovelMint</div>
    <button id="editProfileBtn" class="btn">Edit Profile</button>
    <button id="publishToggle" class="btn">Publish</button>
    <button id="logoutBtn" class="btn danger">Logout</button>
  </aside>

  <main>
    <section class="profile-overview card">
      <h2 id="displayName">Author</h2>
      <div class="profile-meta">
        <p id="bio">â€”</p>
        <p>ðŸ“§ <span id="emailView"></span></p>
        <p>ðŸ•“ Member since: <span id="memberSince">â€”</span></p>
        <p>ðŸ“š Total Content: <span id="totalContent">0</span></p>
        <p>ðŸ‘¥ Readers: <span id="readers">0</span>  â€¢  ðŸ’š Appreciations: <span id="appreciations">0</span></p>
      </div>
      <div class="note">Profile is required to create your public author id. You can edit it anytime.</div>
    </section>

    <section id="publishSection" class="card" style="display:none;max-width:720px">
      <h3 style="color:var(--accent)">Publish New Work</h3>
      <input id="title" placeholder="Title" />
      <select id="type"><option>Story</option><option>Poem</option><option>Book</option><option>Thought</option></select>
      <textarea id="content" rows="6" placeholder="Write your content..."></textarea>
      <input id="cover" type="file" accept="image/*" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="publishBtn" class="btn">Publish</button>
        <div id="publishStatus" class="note"></div>
      </div>
    </section>
  </main>

  <!-- Profile Modal (used for create/edit) -->
  <div id="profileModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card">
      <h3>Create Your Author Profile</h3>
      <p style="color:var(--muted)">This will be shown publicly (name, bio, avatar). Choose a unique username.</p>

      <input id="profileDisplayName" placeholder="Display name (e.g. RiyaWrites)" />
      <input id="profileUsername" placeholder="Username (unique, no spaces) â€” will be used in URL" />
      <textarea id="profileBio" rows="3" placeholder="Short bio (one-liner)"></textarea>
      <input id="profileAvatar" type="file" accept="image/*" />
      <div class="actions">
        <button id="saveProfileBtn" class="btn">Save Profile</button>
        <button id="cancelProfileBtn" class="btn danger">Cancel</button>
      </div>
      <div id="profileStatus" class="note"></div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from "./app.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { doc, getDoc, setDoc, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

    // UI elements
    const editProfileBtn = document.getElementById('editProfileBtn');
    const publishToggle = document.getElementById('publishToggle');
    const logoutBtn = document.getElementById('logoutBtn');
    const displayNameEl = document.getElementById('displayName');
    const bioEl = document.getElementById('bio');
    const emailView = document.getElementById('emailView');
    const memberSinceEl = document.getElementById('memberSince');
    const totalContentEl = document.getElementById('totalContent');
    const readersEl = document.getElementById('readers');
    const apprecEl = document.getElementById('appreciations');

    const publishSection = document.getElementById('publishSection');
    const publishBtn = document.getElementById('publishBtn');
    const publishStatus = document.getElementById('publishStatus');

    const profileModal = document.getElementById('profileModal');
    const profileDisplayName = document.getElementById('profileDisplayName');
    const profileUsername = document.getElementById('profileUsername');
    const profileBio = document.getElementById('profileBio');
    const profileAvatar = document.getElementById('profileAvatar');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const cancelProfileBtn = document.getElementById('cancelProfileBtn');
    const profileStatus = document.getElementById('profileStatus');

    let currentUser = null;
    let currentUserData = null;

    // When auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      emailView.textContent = user.email;
      await ensureUserProfile(user.uid, user);
      await loadUserProfileToUI(user.uid);
      publishSection.style.display = 'block';
    });

    // Ensure user doc exists; if not or incomplete open modal
    async function ensureUserProfile(uid, userObj) {
      try {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          // create minimal private profile
          await setDoc(uref, {
            uid,
            email: userObj.email,
            displayName: userObj.displayName || '',
            username: '',
            bio: '',
            avatarUrl: '',
            joinDate: new Date().toISOString(),
            profileComplete: false
          });
          // open profile modal to complete
          openProfileModal(false);
          return;
        }
        const data = snap.data();
        currentUserData = data;
        // if profile not complete, open modal
        if (!data.profileComplete) {
          openProfileModal(true, data);
        } else {
          // ensure publicUsers doc exists or update
          const pubRef = doc(db, 'publicUsers', uid);
          await setDoc(pubRef, {
            name: data.displayName || (userObj.email.split('@')[0]),
            email: userObj.email,
            joinDate: (data.joinDate) ? new Date(data.joinDate).toLocaleDateString() : new Date().toLocaleDateString(),
            avatarUrl: data.avatarUrl || ''
          }, { merge: true });
        }
      } catch (e) {
        console.error('ensureUserProfile error', e);
      }
    }

    // Load profile info into UI
    async function loadUserProfileToUI(uid) {
      try {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) return;
        const data = snap.data();
        currentUserData = data;
        displayNameEl.textContent = data.displayName || (currentUser.email.split('@')[0]);
        bioEl.textContent = data.bio || 'â€”';
        memberSinceEl.textContent = data.joinDate ? new Date(data.joinDate).toLocaleDateString() : '-';
        readersEl.textContent = data.readers ?? 0;
        apprecEl.textContent = data.appreciations ?? 0;

        // count total contents by this user
        const q = query(collection(db, 'contents'), where('authorId', '==', uid));
        const snapContents = await getDocs(q);
        totalContentEl.textContent = snapContents.size;
      } catch (e) {
        console.error('loadUserProfileToUI', e);
      }
    }

    // Open profile modal (isEdit true if editing existing)
    function openProfileModal(isEdit=false, data={}) {
      profileModal.classList.remove('hidden');
      profileModal.setAttribute('aria-hidden','false');
      profileDisplayName.value = data.displayName || '';
      profileUsername.value = data.username || '';
      profileBio.value = data.bio || '';
      profileStatus.textContent = isEdit ? 'Edit and save your profile.' : 'Please complete your author profile to continue.';
    }

    function closeProfileModal() {
      profileModal.classList.add('hidden');
      profileModal.setAttribute('aria-hidden','true');
      profileStatus.textContent = '';
      profileAvatar.value = '';
    }

    // Edit Profile button
    editProfileBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      // load current data
      const snap = await getDoc(doc(db, 'users', currentUser.uid));
      openProfileModal(true, snap.exists() ? snap.data() : {});
    });

    // Cancel profile modal
    cancelProfileBtn.addEventListener('click', () => {
      // If profile not complete, prevent cancelling (force complete) â€” only allow cancel if profile exists
      if (currentUserData && currentUserData.profileComplete) {
        closeProfileModal();
      } else {
        profileStatus.textContent = 'You must complete your profile to proceed.';
      }
    });

    // Save profile (create or update both users and publicUsers)
    saveProfileBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      const displayName = profileDisplayName.value.trim();
      const username = profileUsername.value.trim();
      const bio = profileBio.value.trim();
      const avatarFile = profileAvatar.files[0];

      if (!displayName || !username) {
        profileStatus.textContent = 'Please enter display name and username.';
        return;
      }

      profileStatus.textContent = 'Saving...';

      try {
        // (Optional) check username uniqueness in publicUsers (simple check)
        if (username) {
          const q = query(collection(db, 'publicUsers'), where('username', '==', username));
          const snaps = await getDocs(q);
          // allow if same user owns it or no matches
          const conflict = snaps.docs.some(d => d.id !== currentUser.uid);
          if (conflict) {
            profileStatus.textContent = 'Username already taken. Try another.';
            return;
          }
        }

        // upload avatar if provided
        let avatarUrl = (currentUserData && currentUserData.avatarUrl) ? currentUserData.avatarUrl : '';
        if (avatarFile) {
          const fp = storageRef(storage, `avatars/${currentUser.uid}_${Date.now()}_${avatarFile.name}`);
          await uploadBytes(fp, avatarFile);
          avatarUrl = await getDownloadURL(fp);
        }

        // update private users collection
        const uref = doc(db, 'users', currentUser.uid);
        await setDoc(uref, {
          uid: currentUser.uid,
          email: currentUser.email,
          displayName,
          username,
          bio,
          avatarUrl,
          joinDate: (currentUserData && currentUserData.joinDate) ? currentUserData.joinDate : new Date().toISOString(),
          profileComplete: true,
          readers: currentUserData?.readers ?? 0,
          appreciations: currentUserData?.appreciations ?? 0,
          updatedAt: new Date().toISOString()
        }, { merge: true });

        // update publicUsers (publicly readable)
        const pubRef = doc(db, 'publicUsers', currentUser.uid);
        await setDoc(pubRef, {
          name: displayName,
          username,
          email: currentUser.email,
          joinDate: new Date().toLocaleDateString(),
          avatarUrl
        }, { merge: true });

        profileStatus.textContent = 'Saved âœ…';
        // refresh local UI
        await loadUserProfileToUI(currentUser.uid);
        closeProfileModal();
      } catch (err) {
        console.error('saveProfile error', err);
        profileStatus.textContent = 'Error saving profile: ' + (err.message || err);
      }
    });

    // Publish toggle
    publishToggle.addEventListener('click', () => {
      publishSection.style.display = publishSection.style.display === 'none' ? 'block' : 'none';
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // Publish content handler
    publishBtn.addEventListener('click', async () => {
      if (!currentUser) { publishStatus.textContent = 'Login required.'; return; }
      // Ensure profile complete before publishing
      if (!currentUserData || !currentUserData.profileComplete) {
        publishStatus.textContent = 'Complete your profile first.';
        openProfileModal(false, currentUserData || {});
        return;
      }

      const title = document.getElementById('title').value.trim();
      const type = document.getElementById('type').value;
      const content = document.getElementById('content').value.trim();
      const cover = document.getElementById('cover').files[0];

      if (!title || !content) {
        publishStatus.textContent = 'Title and content required.';
        return;
      }

      publishStatus.textContent = 'Publishing...';

      try {
        let coverUrl = '';
        if (cover) {
          const cref = storageRef(storage, `covers/${currentUser.uid}_${Date.now()}_${cover.name}`);
          await uploadBytes(cref, cover);
          coverUrl = await getDownloadURL(cref);
        }

        await addDoc(collection(db, 'contents'), {
          title,
          type,
          content,
          coverUrl,
          author: currentUserData.displayName || currentUser.email.split('@')[0],
          authorId: currentUser.uid,
          publishDate: new Date().toLocaleDateString(),
          createdAt: serverTimestamp()
        });

        publishStatus.textContent = 'Published âœ…';
        // clear fields
        document.getElementById('title').value = '';
        document.getElementById('content').value = '';
        document.getElementById('cover').value = '';
        // update counts
        await loadUserProfileToUI(currentUser.uid);
      } catch (err) {
        console.error('publish error', err);
        publishStatus.textContent = 'Publish failed: ' + (err.message || err);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // Close modal on background click (optional)
    profileModal.addEventListener('click', (e) => {
      if (e.target === profileModal) {
        if (currentUserData && currentUserData.profileComplete) closeProfileModal();
      }
    });
  </script>
</body>
</html>
