<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovelMint â€” Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #0e0e1a;
      color: white;
    }

    .dashboard {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #1b1b2f;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }

    .sidebar h2 {
      color: #5f4dee;
    }

    .sidebar button {
      width: 90%;
      margin: 10px 0;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #5f4dee;
      color: white;
      cursor: pointer;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    header input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 20px;
    }

    .profile-section {
      background: #22223b;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .profile-section p {
      margin: 8px 0;
    }

    .work-card {
      background: #2a2a4b;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1b1b2f;
      padding: 20px;
      border-radius: 10px;
      width: 320px;
    }

    input,
    select,
    textarea {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 5px;
    }

    button {
      background: #5f4dee;
      color: white;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        padding: 10px;
      }

      .main-content {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>NovelMint</h2>
      <button id="publishBtn">ðŸ“– Publish</button>
      <button id="logoutBtn">ðŸšª Logout</button>
    </aside>

    <main class="main-content">
      <header>
        <input type="text" id="searchBar" placeholder="Search your works..." />
      </header>

      <section class="profile-section">
        <h3 id="authorName">Author Name</h3>
        <p>ðŸ“š Total Content: <span id="totalContent">0</span></p>
        <p>ðŸ‘¥ Readers: <span id="readers">0</span></p>
        <p>ðŸ’š Appreciations: <span id="appreciations">0</span></p>
        <p>ðŸ•“ Member Since: <span id="memberSince"></span></p>
      </section>

      <section id="contentList">
        <h4>Your Works</h4>
        <div id="worksContainer"></div>
      </section>
    </main>
  </div>

  <!-- Publish Modal -->
  <div id="publishModal" class="modal">
    <div class="modal-content">
      <h3>Publish New Work</h3>
      <input type="text" id="title" placeholder="Title" />
      <select id="type">
        <option>Story</option>
        <option>Poem</option>
        <option>Book</option>
        <option>Thought</option>
      </select>
      <textarea id="content" placeholder="Write your content..."></textarea>
      <input type="file" id="cover" />
      <button id="submitPublish">Publish</button>
      <button id="closeModal">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from "./app.js";
    import {
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import {
      collection,
      addDoc,
      getDocs,
      query,
      where,
      doc,
      setDoc,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-storage.js";

    const logoutBtn = document.getElementById("logoutBtn");
    const publishBtn = document.getElementById("publishBtn");
    const modal = document.getElementById("publishModal");
    const closeModal = document.getElementById("closeModal");
    const submitPublish = document.getElementById("submitPublish");

    const userName = document.getElementById("authorName");
    const totalContent = document.getElementById("totalContent");
    const readers = document.getElementById("readers");
    const appreciations = document.getElementById("appreciations");
    const memberSince = document.getElementById("memberSince");
    const worksContainer = document.getElementById("worksContainer");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        userName.textContent = user.email.split("@")[0];

        // Load member info or create if not exist
        const userRef = doc(db, "authors", user.uid);
        const docSnap = await getDoc(userRef);

        if (!docSnap.exists()) {
          await setDoc(userRef, {
            readers: 0,
            appreciations: 0,
            joinDate: new Date().toISOString(),
          });
          memberSince.textContent = new Date().toLocaleDateString();
        } else {
          const data = docSnap.data();
          readers.textContent = data.readers;
          appreciations.textContent = data.appreciations;
          memberSince.textContent = new Date(data.joinDate).toLocaleDateString();
        }

        // Load userâ€™s contents
        const q = query(
          collection(db, "contents"),
          where("authorId", "==", user.uid)
        );
        const snapshot = await getDocs(q);
        totalContent.textContent = snapshot.size;
        worksContainer.innerHTML = "";
        snapshot.forEach((docu) => {
          const d = docu.data();
          worksContainer.innerHTML += `<div class="work-card"><h5>${d.title}</h5><p>${d.type}</p></div>`;
        });
      }
    });

    // Publish new work
    publishBtn.addEventListener("click", () => (modal.style.display = "flex"));
    closeModal.addEventListener("click", () => (modal.style.display = "none"));

    submitPublish.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      const title = document.getElementById("title").value;
      const type = document.getElementById("type").value;
      const content = document.getElementById("content").value;
      const cover = document.getElementById("cover").files[0];

      let coverUrl = "";
      if (cover) {
        const coverRef = ref(storage, `covers/${user.uid}_${Date.now()}`);
        await uploadBytes(coverRef, cover);
        coverUrl = await getDownloadURL(coverRef);
      }

      await addDoc(collection(db, "contents"), {
        title,
        type,
        content,
        coverUrl,
        authorId: user.uid,
        createdAt: new Date().toISOString(),
      });

      alert("Published successfully!");
      modal.style.display = "none";
      location.reload();
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
