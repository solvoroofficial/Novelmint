<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Profile - NovelMint</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f9fff9;
      margin: 0;
      padding: 2rem;
      color: #222;
    }
    .profile-container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    .profile-header {
      text-align: center;
    }
    .profile-header img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid #45b97c;
      object-fit: cover;
    }
    .username {
      color: #555;
      text-decoration: none;
    }
    .username:hover {
      color: #45b97c;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin: 1.2rem 0;
      background: #f0fff5;
      padding: 0.8rem;
      border-radius: 10px;
    }
    .stats div {
      text-align: center;
    }
    .about {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 10px;
      min-height: 80px;
    }
    button {
      background: #45b97c;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1rem;
      font-weight: 600;
    }
    button:hover {
      background: #39a06b;
    }
    .hidden { display: none; }
    .published-works {
      margin-top: 2rem;
    }
    .work-card {
      background: #f7fff9;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border: 1px solid #e2f3e9;
    }
    input, textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="profile-header">
      <img id="profilePic" src="default-profile.jpg" alt="Profile Picture" />
      <h2 id="displayName">Loading...</h2>
      <a id="usernameLink" href="#" class="username">@username</a>
      <p id="email"></p>
      <button id="editBtn">Edit Profile</button>
      <button id="saveBtn" class="hidden">Save</button>
    </div>

    <div class="stats">
      <div><h3 id="totalContent">0</h3><p>Contents</p></div>
      <div><h3 id="readers">0</h3><p>Readers</p></div>
      <div><h3 id="appreciations">0</h3><p>Appreciations</p></div>
    </div>

    <div class="about">
      <h4>About</h4>
      <p id="aboutText">Write something about yourself...</p>
      <textarea id="aboutInput" class="hidden"></textarea>
    </div>

    <div class="published-works">
      <h3>Your Published Works</h3>
      <div id="worksList">Loading your content...</div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./app.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const displayNameEl = document.getElementById("displayName");
    const usernameLink = document.getElementById("usernameLink");
    const aboutText = document.getElementById("aboutText");
    const aboutInput = document.getElementById("aboutInput");
    const emailEl = document.getElementById("email");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const totalContentEl = document.getElementById("totalContent");
    const readersEl = document.getElementById("readers");
    const appreciationsEl = document.getElementById("appreciations");
    const worksList = document.getElementById("worksList");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        displayNameEl.textContent = "User not found.";
        return;
      }

      const data = userSnap.data();
      const username = data.username || user.email.split("@")[0];

      displayNameEl.textContent = data.name || "Author";
      usernameLink.textContent = "@" + username;
      usernameLink.href = `anotherprofile.html?user=${username}`;
      emailEl.textContent = user.email;
      aboutText.textContent = data.about || "Write something about yourself...";
      totalContentEl.textContent = data.totalContent || 0;
      readersEl.textContent = data.readers || 0;
      appreciationsEl.textContent = data.appreciations || 0;

      // 🔄 Real-time content update
      const postQuery = query(collection(db, "posts"), where("authorId", "==", user.uid));
      onSnapshot(postQuery, (snap) => {
        worksList.innerHTML = "";
        if (snap.empty) {
          worksList.innerHTML = "<p>No published works yet.</p>";
        } else {
          totalContentEl.textContent = snap.size;
          snap.forEach((doc) => {
            const post = doc.data();
            const div = document.createElement("div");
            div.classList.add("work-card");
            div.innerHTML = `<h4>${post.title}</h4><p>${post.excerpt || post.text.slice(0,80) + "..."}</p>`;
            worksList.appendChild(div);
          });
        }
      });

      // ✏️ Edit mode
      editBtn.addEventListener("click", () => {
        aboutInput.value = aboutText.textContent;
        aboutText.classList.add("hidden");
        aboutInput.classList.remove("hidden");
        editBtn.classList.add("hidden");
        saveBtn.classList.remove("hidden");
      });

      // 💾 Save mode
      saveBtn.addEventListener("click", async () => {
        const newAbout = aboutInput.value.trim();
        await updateDoc(userRef, { about: newAbout });
        aboutText.textContent = newAbout || "Write something about yourself...";
        aboutText.classList.remove("hidden");
        aboutInput.classList.add("hidden");
        editBtn.classList.remove("hidden");
        saveBtn.classList.add("hidden");
      });
    });
  </script>
</body>
</html>
