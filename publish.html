<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovelMint ‚Äî Dashboard (Publish)</title>
  <link rel="icon" href="favicon.png" />
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #ffffff;
      color: #111;
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR / HEADER */
    header {
      background: #fff;
      border-right: 1px solid #e5e7eb;
      width: 250px;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: fixed;
      height: 100vh;
      box-sizing: border-box;
      z-index: 100;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .logo-section img { width: 38px; height: 38px; border-radius: 50%; }
    .logo-section span { font-size: 1.2rem; font-weight: 600; color: #16a34a; }

    nav { display:flex; flex-direction:column; gap:12px; margin-top:10px; }
    nav a { text-decoration: none; color: #111; font-weight: 500; font-size: 1.02em; }
    nav a:hover { color:#16a34a; }

    footer { text-align:center; font-size:0.85em; color:#6b7280; border-top:1px solid #e5e7eb; padding-top:10px; margin-top:20px; }

    /* MAIN */
    main {
      flex: 1;
      margin-left: 250px;
      padding: 24px;
      box-sizing: border-box;
    }

    .publish {
      max-width: 820px;
      margin: 0 auto;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    .publish h3 { color: #16a34a; margin: 0 0 12px 0; }
    .row { display:flex; gap:12px; align-items:center; }
    .col { flex:1; }
    label { display:block; font-size:0.9rem; color:#374151; margin-bottom:6px; }
    input[type="text"], input[type="date"], select, textarea {
      width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; color:#111; font-size:1rem; box-sizing:border-box;
    }
    textarea { resize:vertical; min-height:100px; }

    .small { font-size:0.9rem; color:#6b7280; margin-top:6px; }
    .muted { color:#6b7280; font-size:0.9rem; }

    .actions { display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap; }
    button {
      background: #16a34a; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:1rem;
    }
    button.secondary { background:#f3f4f6; color:#111; border:1px solid #e5e7eb; }
    button.danger { background:#ef4444; }

    .status { margin-top:10px; font-size:0.95rem; }
    .status.success { color: #15803d; }
    .status.error { color: #dc2626; }
    .progress { height:8px; background:#e6f4ea; border-radius:6px; overflow:hidden; margin-top:8px; }
    .progress > span { display:block; height:100%; width:0%; background:#16a34a; transition:width 0.2s ease; }

    /* responsive */
    @media (max-width: 880px) {
      .row { flex-direction:column; align-items:stretch; }
    }

    /* MOBILE header behavior */
    @media (max-width: 768px) {
      body { flex-direction: column; }
      header {
        flex-direction: row; align-items:center; justify-content:space-between; position: sticky; top:0; width:100%;
        height:auto; border-right:none; border-bottom:1px solid #e5e7eb; padding:10px 16px;
      }
      nav { display:none; position:absolute; top:60px; right:0; width:100%; background:#fff; border-top:1px solid #e5e7eb; text-align:center; padding:8px 0; }
      nav.active { display:flex; flex-direction:column; gap:10px; }
      main { margin-left:0; padding:16px; }
      footer { display:none; }
      .menu-toggle { display:flex; gap:4px; flex-direction:column; }
      .menu-toggle span { width:24px; height:3px; background:#111; border-radius:2px; display:block; }
    }
    .menu-toggle { display:none; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Header (left on desktop, top on mobile) -->
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="logo-section">
        <img src="logo.png" alt="NovelMint logo" style="width:38px;height:38px;border-radius:50%;">
        <span>NovelMint</span>
      </div>

      <div class="menu-toggle" id="menuToggle" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
    </div>

    <nav id="navMenu" aria-label="Main navigation">
      <a href="index.html">üìö Library</a>
      <a href="dashboard.html">üìä Dashboard</a>
      <a href="publish.html">‚úçÔ∏è Publish</a>
    </nav>

    <footer>¬© 2025 NovelMint</footer>
  </header>

  <!-- Main: Publish form with extra features -->
  <main>
    <div class="publish" id="publishForm">
      <h3>üìñ Publish New Content</h3>

      <div class="row" style="margin-bottom:12px;">
        <div class="col">
          <label for="title">Title</label>
          <input id="title" type="text" placeholder="Enter title" />
        </div>

        <div style="width:160px;">
          <label for="type">Type</label>
          <select id="type">
            <option>Story</option>
            <option>Short Story</option>
            <option>Flash Fiction</option>
            <option>Poem</option>
            <option>Quote</option>
            <option>Article</option>
            <option>Essay</option>
            <option>Book</option>
            <option>Short Book</option>
            <option>Thought</option>
          </select>
        </div>
      </div>

      <label for="excerpt">Excerpt (optional)</label>
      <textarea id="excerpt" rows="3" placeholder="Short excerpt or description (appears on cards)"></textarea>
      <div class="small muted" id="excerptCount">0 / 300</div>

      <label for="content">Content</label>
      <textarea id="content" rows="8" placeholder="Write your content..."></textarea>
      <div class="small muted" id="contentCount">0 characters</div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label for="cover">Cover image (optional)</label>
          <input id="cover" type="file" accept="image/*" />
          <div class="small muted">Best: 1200√ó675 px. Max 10 MB recommended.</div>
        </div>

        <div style="width:220px;">
          <label for="visibility">Visibility</label>
          <select id="visibility">
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="draft">Draft</option>
          </select>

          <label for="publishDate" style="margin-top:10px;">Publish on (optional)</label>
          <input id="publishDate" type="date" />
        </div>
      </div>

      <label for="tags" style="margin-top:12px;">Tags (comma separated)</label>
      <input id="tags" type="text" placeholder="e.g. romance, short, inspirational" />

      <!-- File upload for Book / Short Book -->
      <div id="fileSection" style="margin-top:12px; display:none;">
        <label for="bookFile">Attach file (PDF / EPUB / DOCX) ‚Äî max 100 MB</label>
        <input id="bookFile" type="file" accept=".pdf,.epub,application/epub+zip,application/pdf,.doc,.docx" />
        <div class="small muted" id="fileInfo">No file selected.</div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="publishBtn">Publish</button>
        <button class="secondary" id="clearBtn" type="button">Clear</button>
        <button class="secondary" id="previewBtn" type="button">Preview</button>
      </div>

      <!-- progress / status -->
      <div id="uploadProgress" class="progress" style="display:none;">
        <span style="width:0%"></span>
      </div>
      <div id="status" class="status muted"></div>
    </div>
  </main>

  <!-- Firebase + logic (uses same imports pattern as your app.js setup) -->
  <script type="module">
    import { auth, db, storage } from "./app.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

    // Elements
    const typeEl = document.getElementById("type");
    const bookFileEl = document.getElementById("bookFile");
    const fileSection = document.getElementById("fileSection");
    const fileInfo = document.getElementById("fileInfo");

    const titleEl = document.getElementById("title");
    const excerptEl = document.getElementById("excerpt");
    const contentEl = document.getElementById("content");
    const coverEl = document.getElementById("cover");
    const tagsEl = document.getElementById("tags");
    const publishDateEl = document.getElementById("publishDate");
    const visibilityEl = document.getElementById("visibility");

    const publishBtn = document.getElementById("publishBtn");
    const clearBtn = document.getElementById("clearBtn");
    const previewBtn = document.getElementById("previewBtn");

    const statusDiv = document.getElementById("status");
    const uploadProgress = document.getElementById("uploadProgress");
    const progressBar = uploadProgress.querySelector("span");

    const excerptCount = document.getElementById("excerptCount");
    const contentCount = document.getElementById("contentCount");

    let currentUser = null;

    // show/hide file section when type changes
    function updateFileSection() {
      const t = typeEl.value.toLowerCase();
      // show for book or short book
      if (t.includes("book")) {
        fileSection.style.display = "block";
      } else {
        fileSection.style.display = "none";
        bookFileEl.value = "";
        fileInfo.textContent = "No file selected.";
      }
    }

    typeEl.addEventListener("change", updateFileSection);

    // file info & size check
    bookFileEl.addEventListener("change", () => {
      const f = bookFileEl.files[0];
      if (!f) { fileInfo.textContent = "No file selected."; return; }
      const max = 100 * 1024 * 1024; // 100 MB
      if (f.size > max) {
        fileInfo.textContent = `‚ùå File too large (${(f.size/1024/1024).toFixed(2)} MB). Max 100 MB.`;
        fileInfo.classList.add("error");
      } else {
        fileInfo.textContent = `${f.name} ‚Äî ${(f.size/1024/1024).toFixed(2)} MB`;
      }
    });

    // counts
    excerptEl.addEventListener("input", () => {
      const len = excerptEl.value.length;
      excerptCount.textContent = `${len} / 300`;
      if (len > 300) excerptCount.style.color = "#dc2626"; else excerptCount.style.color = "#6b7280";
    });

    contentEl.addEventListener("input", () => {
      contentCount.textContent = `${contentEl.value.length} characters`;
    });

    // auth check
    onAuthStateChanged(auth, (user) => {
      if (user) currentUser = user;
      else window.location.href = "login.html";
    });

    // clear
    clearBtn.addEventListener("click", () => {
      titleEl.value = "";
      excerptEl.value = "";
      contentEl.value = "";
      coverEl.value = "";
      bookFileEl.value = "";
      tagsEl.value = "";
      publishDateEl.value = "";
      visibilityEl.value = "public";
      statusDiv.textContent = "";
      progressBar.style.width = "0%";
      uploadProgress.style.display = "none";
      updateFileSection();
    });

    // preview (simple)
    previewBtn.addEventListener("click", () => {
      const previewWindow = window.open("", "_blank", "width=700,height=800");
      const html = `
        <html><head><title>Preview - ${escapeHtml(titleEl.value || "Untitled")}</title></head>
        <body style="font-family:Arial,Helvetica,sans-serif;padding:20px;">
          <h1 style="color:#16a34a;">${escapeHtml(titleEl.value || "Untitled")}</h1>
          <h4 style="color:#6b7280;">${escapeHtml(excerptEl.value || "")}</h4>
          <pre style="white-space:pre-wrap;font-size:1rem;color:#111;">${escapeHtml(contentEl.value || "")}</pre>
        </body></html>`;
      previewWindow.document.write(html);
      previewWindow.document.close();
    });

    // Publishing logic (uploads cover + optional book file)
    publishBtn.addEventListener("click", async () => {
      if (!currentUser) { statusDiv.textContent = "‚ö†Ô∏è You must be logged in."; statusDiv.className = "status error"; return; }

      const title = titleEl.value.trim();
      const excerpt = excerptEl.value.trim();
      const content = contentEl.value.trim();
      const type = typeEl.value;
      const tags = tagsEl.value.split(",").map(t => t.trim()).filter(Boolean);
      const visibility = visibilityEl.value;
      const publishOn = publishDateEl.value || null;
      const coverFile = coverEl.files[0];
      const bookFile = bookFileEl.files[0];

      if (!title || !content) {
        statusDiv.textContent = "‚ö†Ô∏è Title and content are required.";
        statusDiv.className = "status error";
        return;
      }

      // book file size check
      if (bookFile) {
        const max = 100 * 1024 * 1024;
        if (bookFile.size > max) {
          statusDiv.textContent = `‚ùå Attached file is too large (${(bookFile.size/1024/1024).toFixed(2)}MB). Max 100 MB.`;
          statusDiv.className = "status error";
          return;
        }
      }

      publishBtn.disabled = true;
      publishBtn.textContent = "Publishing...";
      statusDiv.textContent = "Uploading resources...";
      statusDiv.className = "status muted";

      try {
        uploadProgress.style.display = "none";
        progressBar.style.width = "0%";

        // helper to upload a file and return URL (with simple progress)
        async function uploadFile(file, folder) {
          if (!file) return "";
          const fileName = `${folder}/${Date.now()}-${file.name.replace(/\s+/g,'_')}`;
          const storageRef = ref(storage, fileName);
          const uploadTask = uploadBytesResumable(storageRef, file);

          return new Promise((resolve, reject) => {
            uploadProgress.style.display = "block";
            uploadTask.on('state_changed',
              (snapshot) => {
                const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                progressBar.style.width = percent + '%';
              },
              (err) => {
                uploadProgress.style.display = "none";
                reject(err);
              },
              async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                uploadProgress.style.display = "none";
                progressBar.style.width = "0%";
                resolve(url);
              }
            );
          });
        }

        // upload cover (if any)
        let coverUrl = "";
        if (coverFile) {
          statusDiv.textContent = "Uploading cover image...";
          coverUrl = await uploadFile(coverFile, "covers");
        }

        // upload book file (if any)
        let bookFileUrl = "";
        let bookFileName = "";
        if (bookFile) {
          statusDiv.textContent = "Uploading attached file (may take a while)...";
          bookFileUrl = await uploadFile(bookFile, "books");
          bookFileName = bookFile.name;
        }

        // finally add doc to Firestore
        statusDiv.textContent = "Saving content...";
        const docData = {
          title,
          excerpt,
          content,
          type,
          tags,
          visibility,
          coverUrl: coverUrl || "",
          fileUrl: bookFileUrl || "",
          fileName: bookFileName || "",
          author: currentUser.email ? currentUser.email.split("@")[0] : "unknown",
          authorId: currentUser.uid,
          publishDate: publishOn || new Date().toLocaleDateString(),
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "contents"), docData);

        statusDiv.textContent = "‚úÖ Published successfully!";
        statusDiv.className = "status success";
        publishBtn.textContent = "Publish";
        publishBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå " + (err.message || "Upload failed");
        statusDiv.className = "status error";
        publishBtn.disabled = false;
        publishBtn.textContent = "Publish";
      }
    });

    // mobile nav toggle
    const menuToggle = document.getElementById("menuToggle");
    const navMenu = document.getElementById("navMenu");
    menuToggle.addEventListener("click", () => navMenu.classList.toggle("active"));

    // small utility
    function escapeHtml(s = "") {
      return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
    }

    // initialize file section visibility
    updateFileSection();
  </script>
</body>
</html>
