<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovelMint ‚Äî Dashboard (Publish)</title>
  <link rel="icon" href="favicon.png" />
  <style>
    :root{
      --accent: #16a34a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #ffffff;
      --card: #f9fafb;
      --bottom-height: 64px;
    }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      color: #111;
      display: flex;
      min-height: 100vh;
    }

    /* ==== SIDEBAR (desktop) - UNCHANGED ==== */
    header {
      background: #fff;
      border-right: 1px solid var(--border);
      width: 250px;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: fixed;
      height: 100vh;
      box-sizing: border-box;
      z-index: 100;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .logo-section img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
    }

    .logo-section span {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--accent);
    }

    nav {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    nav a {
      text-decoration: none;
      color: #111;
      font-weight: 500;
      font-size: 1.05em;
      transition: 0.2s;
    }

    nav a:hover, nav a.active {
      color: var(--accent);
    }

    footer {
      text-align: center;
      font-size: 0.85em;
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding-top: 10px;
      margin-top: 30px;
    }

    /* ==== MAIN ==== */
    main {
      flex: 1;
      margin-left: 250px;
      padding: 24px;
      box-sizing: border-box;
      transition: padding-bottom 0.2s;
    }

    .publish {
      max-width: 820px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    .publish h3 { color: var(--accent); margin: 0 0 12px 0; }
    .row { display:flex; gap:12px; align-items:center; }
    .col { flex:1; }
    label { display:block; font-size:0.9rem; color:#374151; margin-bottom:6px; }
    input[type="text"], input[type="date"], select, textarea {
      width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff; color:#111; font-size:1rem; box-sizing:border-box;
    }
    textarea { resize:vertical; min-height:100px; }

    .small { font-size:0.9rem; color:var(--muted); margin-top:6px; }
    .muted { color:var(--muted); }

    .actions { display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap; }
    button {
      background: var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:1rem;
    }
    button.secondary { background:#f3f4f6; color:#111; border:1px solid var(--border); }
    button.danger { background:#ef4444; }

    .status { margin-top:10px; font-size:0.95rem; }
    .status.success { color: #15803d; }
    .status.error { color: #dc2626; }
    .progress { height:8px; background:#e6f4ea; border-radius:6px; overflow:hidden; margin-top:8px; }
    .progress > span { display:block; height:100%; width:0%; background:var(--accent); transition:width 0.2s ease; }

    @media (max-width: 880px) {
      .row { flex-direction:column; align-items:stretch; }
    }

    /* ==== MOBILE BEHAVIOR ==== */
    @media (max-width: 768px) {
      body { flex-direction: column; }

      /* top header becomes slim top bar with logo only */
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        height: auto;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 10px 16px;
        z-index: 120;
      }

      /* hide desktop nav on mobile (we'll use bottom nav) */
      nav { display: none; }

      /* reserve space at bottom for bottom nav to avoid overlap */
      main {
        margin-left: 0;
        padding: 16px;
        padding-bottom: calc(var(--bottom-height) + env(safe-area-inset-bottom));
      }

      footer { display: none; }
    }

    /* ==== BOTTOM MOBILE NAV (only visible on small screens) ==== */
    .bottom-nav {
      display: none;
    }

    @media (max-width: 768px) {
      .bottom-nav {
        display: flex;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: var(--bottom-height);
        padding-bottom: env(safe-area-inset-bottom);
        background: #fff;
        border-top: 1px solid var(--border);
        box-shadow: 0 -6px 18px rgba(0,0,0,0.06);
        align-items: center;
        justify-content: space-around;
        gap: 6px;
        z-index: 130;
      }

      .bottom-nav a {
        text-decoration: none;
        color: #6b7280;
        font-size: 12px;
        display:flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap:4px;
        width: 72px;
        height: 100%;
        box-sizing: border-box;
        padding-top:6px;
      }

      .bottom-nav a .icon {
        font-size: 20px;
        line-height: 1;
      }

      .bottom-nav a.active {
        color: var(--accent);
      }

      /* subtle hit-area and alignment fix on mobile */
      .bottom-nav a:active, .bottom-nav a:focus {
        background: rgba(22,163,74,0.06);
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Header (left on desktop, slim top on mobile) -->
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="logo-section" style="margin:0;">
        <img src="logo.png" alt="NovelMint logo" style="width:38px;height:38px;border-radius:50%;">
        <span>NovelMint</span>
      </div>
    </div>

    <!-- desktop nav remains (hidden on mobile) -->
    <nav id="navMenu" aria-label="Main navigation">
      <a href="index.html">üìö Library</a>
      <a href="dashboard.html" class="active">üìä Dashboard</a>
      <a href="publish.html">‚úçÔ∏è Publish</a>
    </nav>

    <footer>¬© 2025 NovelMint</footer>
  </header>

  <!-- Main: Publish form -->
  <main>
    <div class="publish" id="publishForm">
      <h3>üìñ Publish New Content</h3>

      <div class="row" style="margin-bottom:12px;">
        <div class="col">
          <label for="title">Title</label>
          <input id="title" type="text" placeholder="Enter title" />
        </div>

        <div style="width:160px;">
          <label for="type">Type</label>
          <select id="type">
            <option>Story</option>
            <option>Short Story</option>
            <option>Flash Fiction</option>
            <option>Poem</option>
            <option>Quote</option>
            <option>Article</option>
            <option>Essay</option>
            <option>Book</option>
            <option>Short Book</option>
            <option>Thought</option>
          </select>
        </div>
      </div>

      <label for="excerpt">Excerpt (optional)</label>
      <textarea id="excerpt" rows="3" placeholder="Short excerpt or description (appears on cards)"></textarea>
      <div class="small muted" id="excerptCount">0 / 300</div>

      <label for="content">Content</label>
      <textarea id="content" rows="8" placeholder="Write your content..."></textarea>
      <div class="small muted" id="contentCount">0 characters</div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label for="cover">Cover image (optional)</label>
          <input id="cover" type="file" accept="image/*" />
          <div class="small muted">Best: 1200√ó675 px. Max 10 MB recommended.</div>
        </div>

        <div style="width:220px;">
          <label for="visibility">Visibility</label>
          <select id="visibility">
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="draft">Draft</option>
          </select>

          <label for="publishDate" style="margin-top:10px;">Publish on (optional)</label>
          <input id="publishDate" type="date" />
        </div>
      </div>

      <label for="tags" style="margin-top:12px;">Tags (comma separated)</label>
      <input id="tags" type="text" placeholder="e.g. romance, short, inspirational" />

      <!-- File upload for Book / Short Book -->
      <div id="fileSection" style="margin-top:12px; display:none;">
        <label for="bookFile">Attach file (PDF / EPUB / DOCX) ‚Äî max 100 MB</label>
        <input id="bookFile" type="file" accept=".pdf,.epub,application/epub+zip,application/pdf,.doc,.docx" />
        <div class="small muted" id="fileInfo">No file selected.</div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="publishBtn">Publish</button>
        <button class="secondary" id="clearBtn" type="button">Clear</button>
        <button class="secondary" id="previewBtn" type="button">Preview</button>
      </div>

      <!-- progress / status -->
      <div id="uploadProgress" class="progress" style="display:none;">
        <span style="width:0%"></span>
      </div>
      <div id="status" class="status muted"></div>
    </div>
  </main>

  <!-- Bottom mobile navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Mobile navigation">
    <a href="index.html" id="nav-library" class="">
      <div class="icon">üìö</div>
      <div class="label">Library</div>
    </a>

    <a href="dashboard.html" id="nav-dashboard" class="active">
      <div class="icon">üìä</div>
      <div class="label">Dashboard</div>
    </a>

    <a href="publish.html" id="nav-publish" class="">
      <div class="icon">‚úçÔ∏è</div>
      <div class="label">Publish</div>
    </a>
  </nav>

  <!-- Firebase + logic (keeps same imports pattern) -->
  <script type="module">
    import { auth, db, storage } from "./app.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

    // Elements
    const typeEl = document.getElementById("type");
    const bookFileEl = document.getElementById("bookFile");
    const fileSection = document.getElementById("fileSection");
    const fileInfo = document.getElementById("fileInfo");

    const titleEl = document.getElementById("title");
    const excerptEl = document.getElementById("excerpt");
    const contentEl = document.getElementById("content");
    const coverEl = document.getElementById("cover");
    const tagsEl = document.getElementById("tags");
    const publishDateEl = document.getElementById("publishDate");
    const visibilityEl = document.getElementById("visibility");

    const publishBtn = document.getElementById("publishBtn");
    const clearBtn = document.getElementById("clearBtn");
    const previewBtn = document.getElementById("previewBtn");

    const statusDiv = document.getElementById("status");
    const uploadProgress = document.getElementById("uploadProgress");
    const progressBar = uploadProgress.querySelector("span");

    const excerptCount = document.getElementById("excerptCount");
    const contentCount = document.getElementById("contentCount");

    let currentUser = null;

    // show/hide file section when type changes
    function updateFileSection() {
      const t = (typeEl.value || "").toLowerCase();
      if (t.includes("book")) {
        fileSection.style.display = "block";
      } else {
        fileSection.style.display = "none";
        if (bookFileEl) bookFileEl.value = "";
        if (fileInfo) fileInfo.textContent = "No file selected.";
      }
    }

    typeEl.addEventListener("change", updateFileSection);

    // file info & size check
    if (bookFileEl) {
      bookFileEl.addEventListener("change", () => {
        const f = bookFileEl.files[0];
        if (!f) { fileInfo.textContent = "No file selected."; return; }
        const max = 100 * 1024 * 1024; // 100 MB
        if (f.size > max) {
          fileInfo.textContent = `‚ùå File too large (${(f.size/1024/1024).toFixed(2)} MB). Max 100 MB.`;
        } else {
          fileInfo.textContent = `${f.name} ‚Äî ${(f.size/1024/1024).toFixed(2)} MB`;
        }
      });
    }

    // counts
    excerptEl.addEventListener("input", () => {
      const len = excerptEl.value.length;
      excerptCount.textContent = `${len} / 300`;
      excerptCount.style.color = len > 300 ? "#dc2626" : "var(--muted)";
    });

    contentEl.addEventListener("input", () => {
      contentCount.textContent = `${contentEl.value.length} characters`;
    });

    // auth check
    onAuthStateChanged(auth, (user) => {
      if (user) currentUser = user;
      else window.location.href = "login.html";
    });

    // clear
    clearBtn.addEventListener("click", () => {
      titleEl.value = "";
      excerptEl.value = "";
      contentEl.value = "";
      coverEl.value = "";
      if (bookFileEl) bookFileEl.value = "";
      tagsEl.value = "";
      publishDateEl.value = "";
      visibilityEl.value = "public";
      statusDiv.textContent = "";
      progressBar.style.width = "0%";
      uploadProgress.style.display = "none";
      updateFileSection();
    });

    // preview
    previewBtn.addEventListener("click", () => {
      const previewWindow = window.open("", "_blank", "width=700,height=800");
      const html = `
        <html><head><title>Preview - ${escapeHtml(titleEl.value || "Untitled")}</title></head>
        <body style="font-family:Arial,Helvetica,sans-serif;padding:20px;">
          <h1 style="color:var(--accent);">${escapeHtml(titleEl.value || "Untitled")}</h1>
          <h4 style="color:#6b7280;">${escapeHtml(excerptEl.value || "")}</h4>
          <pre style="white-space:pre-wrap;font-size:1rem;color:#111;">${escapeHtml(contentEl.value || "")}</pre>
        </body></html>`;
      previewWindow.document.write(html);
      previewWindow.document.close();
    });

    // upload helper
    async function uploadFile(file, folder) {
      if (!file) return "";
      const fileName = `${folder}/${Date.now()}-${file.name.replace(/\s+/g,'_')}`;
      const storageRef = ref(storage, fileName);
      const uploadTask = uploadBytesResumable(storageRef, file);

      return new Promise((resolve, reject) => {
        uploadProgress.style.display = "block";
        uploadTask.on('state_changed',
          (snapshot) => {
            const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            progressBar.style.width = percent + '%';
          },
          (err) => {
            uploadProgress.style.display = "none";
            reject(err);
          },
          async () => {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            uploadProgress.style.display = "none";
            progressBar.style.width = "0%";
            resolve(url);
          }
        );
      });
    }

    // publish
    publishBtn.addEventListener("click", async () => {
      if (!currentUser) { statusDiv.textContent = "‚ö†Ô∏è You must be logged in."; statusDiv.className = "status error"; return; }

      const title = titleEl.value.trim();
      const excerpt = excerptEl.value.trim();
      const content = contentEl.value.trim();
      const type = typeEl.value;
      const tags = (tagsEl.value || "").split(",").map(t => t.trim()).filter(Boolean);
      const visibility = visibilityEl.value;
      const publishOn = publishDateEl.value || null;
      const coverFile = coverEl.files[0];
      const bookFile = bookFileEl ? bookFileEl.files[0] : null;

      if (!title || !content) {
        statusDiv.textContent = "‚ö†Ô∏è Title and content are required.";
        statusDiv.className = "status error";
        return;
      }

      if (bookFile) {
        const max = 100 * 1024 * 1024;
        if (bookFile.size > max) {
          statusDiv.textContent = `‚ùå Attached file is too large (${(bookFile.size/1024/1024).toFixed(2)}MB). Max 100 MB.`;
          statusDiv.className = "status error";
          return;
        }
      }

      publishBtn.disabled = true;
      publishBtn.textContent = "Publishing...";
      statusDiv.textContent = "Uploading resources...";
      statusDiv.className = "status muted";

      try {
        // upload cover
        let coverUrl = "";
        if (coverFile) {
          statusDiv.textContent = "Uploading cover image...";
          coverUrl = await uploadFile(coverFile, "covers");
        }

        // upload book file
        let bookFileUrl = "";
        let bookFileName = "";
        if (bookFile) {
          statusDiv.textContent = "Uploading attached file (may take a while)...";
          bookFileUrl = await uploadFile(bookFile, "books");
          bookFileName = bookFile.name;
        }

        // save doc
        statusDiv.textContent = "Saving content...";
        const docData = {
          title,
          excerpt,
          content,
          type,
          tags,
          visibility,
          coverUrl: coverUrl || "",
          fileUrl: bookFileUrl || "",
          fileName: bookFileName || "",
          author: currentUser.email ? currentUser.email.split("@")[0] : "unknown",
          authorId: currentUser.uid,
          publishDate: publishOn || new Date().toLocaleDateString(),
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, "contents"), docData);

        statusDiv.textContent = "‚úÖ Published successfully!";
        statusDiv.className = "status success";
        publishBtn.textContent = "Publish";
        publishBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå " + (err.message || "Upload failed");
        statusDiv.className = "status error";
        publishBtn.disabled = false;
        publishBtn.textContent = "Publish";
      }
    });

    // bottom nav active-state handling (for SPA-like highlighting)
    const bottomLinks = {
      library: document.getElementById("nav-library"),
      dashboard: document.getElementById("nav-dashboard"),
      publish: document.getElementById("nav-publish")
    };
    function setActiveBottom(id){
      Object.values(bottomLinks).forEach(a => a.classList.remove("active"));
      if (bottomLinks[id]) bottomLinks[id].classList.add("active");
    }
    // set current active by pathname
    if (location.pathname.includes("publish")) setActiveBottom("publish");
    else if (location.pathname.includes("dashboard")) setActiveBottom("dashboard");
    else setActiveBottom("library");

    // utility
    function escapeHtml(s = "") {
      return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
    }

    // init
    updateFileSection();
  </script>
</body>
</html>
